---
title: "Big Data in R with Spark"
author: "Kevin Putschko"
date: "`r Sys.Date()`"
output: 
  prettydoc::html_pretty:
    theme: architect
    highlight: github
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, error = FALSE)

pacman::p_load(tidyverse, leaflet, DT, lubridate,
               colorspace, extrafont, scales, ggthemes,
               RColorBrewer)


report_assets <- read_rds("models/2020-02-26/summary.rds")

report_dtmin <- report_assets$s_summary$date_min %>% format("%b %Y")
report_dtmax <- report_assets$s_summary$date_max %>% format("%b %Y")
```

### Our Test Cases

Using `R 3.6.2`, with `Spark 2.4` and `sparklyr 1.1` on the following computing environments: 

Environment | Resources | Analogy
------------|-----------|---------
Experis Laptop | 8GB RAM, 1 CPU, 4 Core; Intel i5 |  Just you, doing research in a library
AWS EC2 Server | 32GB RAM, 8 CPU, 1 Core; t2.2xlarge | You with a cart, doing research in a library
Databricks Spark Cluster | 32GB RAM, 1 Driver, 4 Worker; i3.xlarge  | You, acting as the project manager, overseeing 4 assistants doing research in a library

### New York City Taxi Requests

We see a representation of the taxi requests in early 2009.  The requests seem to be centered around the middle of Manhattan, with fewer requests as you move north, and east into Brooklyn.

```{r requests}
map_center <-
  report_assets$s_centers %>%
  summarise_at(vars(center_lon, center_lat), mean) %>%
  as.list()

report_assets$s_centers %>%
  leaflet(width = "100%") %>%
  addProviderTiles(providers$CartoDB.DarkMatterNoLabels, group = "New York City") %>%
  addCircles(lng = ~ center_lon,
             lat = ~ center_lat,
             label = ~str_c("Hub - ", taxi_hub),
             color = ~hub_color,
             stroke = TRUE,
             weight = 2.5,
             opacity = 0.75,
             fillColor = "transparent",
             radius = ~if_else(hub_pct > .20, 2500, 5000),
             group = "Hub Clusters") %>%
  addCircleMarkers(data = report_assets$s_blackmap,
                   lng = ~lon_r,
                   lat = ~lat_r,
                   fillOpacity = 0.075,
                   radius = ~log(n),
                   stroke = FALSE,
                   color = "yellow",
                   popup = NULL,
                   group = "Taxi Requests") %>%
  addLayersControl(overlayGroups = c("Taxi Requests", "Hub Clusters"),
                   options = layersControlOptions(collapsed = FALSE)) %>%
  hideGroup("Hub Clusters") %>%
  setView(lng = map_center$center_lon, lat = map_center$center_lat, zoom = 10)
```


### New York City Taxi - Heat Map

Notice the lull in the early morning, and then an increase in taxi requests as rush hour approaches.

```{r heatmap-1, fig.align='center', fig.height=3, cache=TRUE}
report_assets$s_heatmap %>%
  ggplot(aes(x = pickup_hour, y = pickup_wday, fill = rides)) +
  geom_tile() +
  coord_equal() +
  scale_fill_viridis_c(label = number_format(big.mark = ",", scale = 1/1000, suffix = "k")) +
  labs(title = "New York City Taxi Service", 
       subtitle = "Total number of taxi rides by hour and weekday",
       fill = NULL,
       x = NULL,
       y = NULL,
       caption = str_glue("Data ranges from {report_dtmin} to {report_dtmax}")) +
  theme_minimal(base_family = "Trebuchet MS") +
  theme(plot.title = element_text(family = "Calibri", face = "bold", size = 16))
```

We can see here that the fare per hour peaks at around $5/mile in the later weekdays, and again at the beginning and end of the working days.  

```{r heatmap-2, fig.align='center', fig.height=3, cache=TRUE}
report_assets$s_heatmap %>%
  ggplot(aes(x = pickup_hour, y = pickup_wday, fill = fpm)) +
  geom_tile() +
  coord_equal() +
  scale_fill_viridis_c(label = dollar_format()) +
  labs(title = "New York City Taxi Service", 
       subtitle = "Average fare per mile by hour and weekday",
       fill = NULL,
       x = NULL,
       y = NULL,
       caption = str_glue("Data ranges from {report_dtmin} to {report_dtmax}")) +
  theme_minimal(base_family = "Trebuchet MS") +
  theme(plot.title = element_text(family = "Calibri", face = "bold", size = 16))
```

### Environment Comparison

```{r clean-logs, fig.align='center', fig.height=6, fig.width=8}

raw_logs <- 
  read_csv("plot-runtime-logs.csv", col_types = cols()) %>% 
  mutate(label = str_c(env, ram, sep = "\n")) %>% 
  mutate_at(vars(env, ram, rows, label), fct_inorder) %>% 
  mutate_at(vars(stage), fct_rev) 


plot_40 <- 
  raw_logs %>% 
  filter(group == "B") %>% 
  ggplot(aes(x = label, y = min, fill = stage, color = stage)) +
  geom_col(width = 0.40) +
  scale_y_continuous(labels = label_number(accuracy = 1, suffix = " mins"),
                     breaks = c(10, 20)) +
  scale_color_manual(values = darken(c("#E41A1C", "#377EB8"), amount = 0.10)) +
  labs(x = NULL, y = NULL, fill = NULL, color = NULL, subtitle = "40 Million Rows") +
  theme_fivethirtyeight(base_family = "Trebuchet MS") +
  theme(plot.subtitle = element_text(hjust = 0.50))
  
plot_20 <- 
  raw_logs %>% 
  filter(group == "A") %>% 
  ggplot(aes(x = label, y = min, fill = stage, color = stage)) +
  geom_col(width = 0.50) +
  scale_y_continuous(labels = label_number(accuracy = 1, suffix = " mins"),
                     breaks = c(20, 40)) +
  scale_color_manual(values = darken(c("#E41A1C", "#377EB8"), amount = 0.10)) +
  labs(x = NULL, y = NULL, fill = NULL, color = NULL, subtitle = "20 Million Rows") +
  guides(color = "none", fill = "none") +
  theme_fivethirtyeight(base_family = "Trebuchet MS") +
  theme(plot.subtitle = element_text(hjust = 0.50))

plot_340 <- 
  raw_logs %>% 
  filter(group == "C") %>% 
  ggplot(aes(x = label, y = min, fill = stage, color = stage)) +
  geom_col(width = .25) +
  scale_y_continuous(labels = label_number(accuracy = 1, suffix = " mins"),
                     breaks = c(90)) +
  scale_color_manual(values = darken(c("#E41A1C", "#377EB8"), amount = 0.10)) +
  labs(x = NULL, y = NULL, fill = NULL, color = NULL, subtitle = "340 Million Rows") +
  guides(fill = "none", color = "none") +
  theme_fivethirtyeight(base_family = "Trebuchet MS") +
  theme(plot.subtitle = element_text(hjust = 0.50))


plot_40 / (plot_20 + plot_340) + 
  plot_annotation(title = "Runtimes on Various Spark Environments", 
                  theme = theme_fivethirtyeight(base_family = "Calibri"))
```


```{r logs, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
# levels_tbl <- 
#   tibble(env_lab = c("local_5G",
#                      "sas_server_5G_20M",
#                      "sas_server_5G",
#                      "sas_server_10G",
#                      "databricks_i3.xlarge; 1-30gb Driver; 4-30gb Workers",
#                      "i3.xlarge; 32gb; 1d-4w"),
#          labels = c("Experis Laptop",
#                     "AWS EC2",
#                     "AWS EC2",
#                     "AWS EC2",
#                     "DB Cluster",
#                     "DB Cluster"),
#          text = c("<b>Env: Experis Laptop</b> \nRows: 20 Million \nRAM:  5gb",
#                   "<b>Env: AWS EC2</b> \nRows: 20 Million \nRAM:  5gb",
#                   "<b>Env: AWS EC2</b> \nRows: 40 Million \nRAM:  5gb",
#                   "<b>Env: AWS EC2</b> \nRows: 40 Million \nRAM: 10gb",
#                   "<b>Env: Databricks Cluster</b> \nCluster: 1 Driver & 4 Workers \nRows: 40 Million \nRAM: 32gb",
#                   "<b>Env: Databricks Cluster</b> \nCluster: 1 Driver & 4 Workers \nRows: 340 Million \nRAM: 32gb"),
#          colors = brewer.pal(6, "Set2"))
# 
# levels_env <- levels_tbl %>% pull(env_lab)
# levels_col <- levels_tbl %>% select(env_lab, colors) %>% deframe()
# levels_label <- levels_tbl %>% select(env_lab, labels) %>% deframe()
# 
# report_logs <- 
#   dir("runtime_logs", full.names = TRUE, pattern = ".csv") %>% 
#   map_dfr(read_csv, col_type = cols()) %>% 
#   distinct() %>% 
#   filter(timestamp >= "2020-02-26", timestamp <= "2020-03-01",
#          !(run_env == "databricks" & run_ram == "64G"),
#          action != "Model: Load Data") %>% 
#   separate(action, into = c("stage", "step"), sep = ": ") %>% 
#   unite(env_lab, run_env, run_ram) %>% 
#   mutate(env_lab = ifelse(stage == "Model" & env_lab == "sas_server_5G" & minute(timestamp) < 26, 
#                           "sas_server_5G_20M", 
#                           env_lab))
# 
# 
# # Parquet & Pipelines
# report_log_summary_wp <- 
#   report_logs %>% 
#   filter(stage %in% c("Write", "Pipeline")) %>% 
#   group_by(env_lab) %>% 
#   summarise(filesize = sum(filesize, na.rm = TRUE),
#             runtime = sum(runtime)) %>% 
#   left_join(levels_tbl) %>% 
#   mutate_at("env_lab", factor, levels = levels_env)
# 
# plot_rt_pipes <-
#   report_log_summary_wp %>% 
#   ggplot(aes(x = env_lab, y = runtime, fill = env_lab, color = env_lab, text = text)) +
#   geom_col(position = "stack") +
#   scale_y_continuous(labels = label_number(scale = 1/60, accuracy = 1, suffix = " mins"), 
#                      breaks = breaks_width(600)) +
#   scale_x_discrete(label = levels_label) +
#   scale_fill_manual(values = levels_col) +
#   scale_color_manual(values = modify(levels_col, darken, amount = 0.30)) +
#   labs(x = NULL, y = NULL, 
#        title = 'Spark Runtimes: Write Data to Parquet and Build Spark Pipelines', 
#        subtitle = "Includes process of converting raw files to parquet, and building the Spark Pipelines") +
#   guides(fill = "none", color = "none") +
#   theme_minimal() +
#   theme(plot.title = element_text(family = "Calibri", face = "bold", size = 16),
#         plot.subtitle = element_text(family = "Trebuchet MS"), 
#         plot.caption = element_text(family = "Trebuchet MS"))
# 
# # Models
# report_log_summary_m <- 
#   report_logs %>% 
#   filter(stage == "Model") %>% 
#   group_by(env_lab) %>%
#   summarise(n_row = max(n_row, na.rm = TRUE),
#             runtime = sum(runtime, na.rm = TRUE)) %>% 
#   left_join(levels_tbl) %>% 
#   mutate_at("env_lab", factor, levels = levels_env)
# 
# plot_rt_models <- 
#   report_log_summary_m %>% 
#   ggplot(aes(x = env_lab, y = runtime, fill = env_lab, color = env_lab, text = text, label = labels)) +
#   geom_col(position = "stack") +
#   scale_y_continuous(labels = label_number(scale = 1/60, accuracy = 1, suffix = " mins"), 
#                      breaks = breaks_width(900)) +
#   scale_x_discrete(label = levels_label) +
#   scale_fill_manual(values = levels_col) +
#   scale_color_manual(values = modify(levels_col, darken, amount = 0.30)) +
#   labs(x = NULL, y = NULL, 
#        title = 'Spark Runtimes: Cluster, Ride and Fare ML Models', 
#        subtitle = "Includes the entire process of building models for the clusters, rides, and fares") +
#   guides(fill = "none", color = "none") +
#   # coord_flip() +
#   theme_minimal() +
#   theme(plot.title = element_text(family = "Calibri", face = "bold", size = 16),
#         plot.subtitle = element_text(family = "Trebuchet MS"), 
#         plot.caption = element_text(family = "Trebuchet MS"))
# 
# # Special i3 1D 4W - 60GB - 320M Rows
# # plot_bigdata <- 
# read_csv("2020-03-05 - cluster 320m runtimes.csv", col_types = cols()) %>% 
#   mutate(grp = ifelse(str_detect(action, "Write: |Pipeline: "), "Write Data and Build Pipelines", "Model Building")) %>% 
#   group_by(grp, run_env, run_ram) %>% 
#   summarise(runtime = sum(runtime),
#             n_row = max(n_row, na.rm = TRUE)) %>% 
#   left_join(levels_tbl, by = c("run_ram" = "env_lab")) %>% 
#   ggplot(aes(x = fct_rev(grp), y = runtime, text = text)) +
#   geom_col()
```

```{r runtime, fig.width=7, fig.align='center'}
# plotly::ggplotly(plot_rt_pipes, tooltip = c("text", "y")) %>% 
#   plotly::layout(showlegend = FALSE)
# 
# plotly::ggplotly(plot_rt_models, tooltip = c("text", "y")) %>% 
#   plotly::layout(showlegend = FALSE)
```

### Conclusion

