---
title: "NYC Taxi - Model Report"
author: "Kevin Putschko"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
pacman::p_load(tidyverse, lubridate, scales, leaflet, DT)

local_path <- "C:/Users/exp01754/OneDrive/Data/cs_bignyctaxi"

model_summaries <- 
  file.path(local_path, "model_summary/summary.rds") %>% 
  read_rds()

runtime_summary <- 
  file.path(local_path, "runtime_logs") %>% 
  dir(full.names = TRUE) %>% 
  map_dfr(read_csv)


display_rundate <- 
  runtime_summary %>% 
  filter(str_detect(action, "predict")) %>% 
  pull(timestamp) %>% 
  date() %>% 
  format("%d %b %Y")

display_runtime_s <- 
  runtime_summary %>% 
  filter(str_detect(action, "predict")) %>% 
  pull(time) %>% 
  number()

display_rows <- 
  model_summaries$s_summary$n[[1]] %>% 
  number(big.mark = ",")

display_date_min <- model_summaries$s_summary$date_min[[1]] %>% format("%b %Y")
display_date_max <- model_summaries$s_summary$date_max[[1]] %>% format("%b %Y")
```


### Introduction

The models were refreshed on `r display_runtime_s`.  

It took `r display_runtime_s` seconds.

The data had `r display_rows` rows.

Table here:

```{r runtime_table}
runtime_summary %>% datatable()
```

### Data Exploration

Here it is...

```{r heatmap, fig.align='center', out.width="100%", fig.height=2}
model_summaries$s_heatmap %>%
  ggplot(aes(x = pickup_hour, y = pickup_wday, fill = rides)) +
  geom_tile() +
  coord_equal() +
  scale_fill_viridis_c(label = number_format()) +
  labs(title = "New York City Taxi Rides", 
       subtitle = "Number of Taxi Rides by Hour and Weekday",
       fill = "Rides\nper Hour",
       x = "Hour of the Day",
       y = "Day of the Week",
       caption = str_glue("Data ranges from {display_date_min} to {display_date_max}")) +
  theme_gray()

model_summaries$s_heatmap %>%
  ggplot(aes(x = pickup_hour, y = pickup_wday, fill = fpm)) +
  geom_tile() +
  coord_equal() +
  scale_fill_viridis_c(label = dollar_format()) +
  labs(title = "New York City Taxi Rides", 
       subtitle = "Average Fare per Mile by Hour and Weekday",
       fill = "Average Fare\nper Mile",
       x = "Hour of the Day",
       y = "Day of the Week",
       caption = str_glue("Data ranges from {display_date_min} to {display_date_max}")) +
  theme_gray()

```

### Map

This and that...

```{r clusters}
map_center <-
  model_summaries$s_centers %>%
  summarise_at(vars(center_lon, center_lat), mean) %>%
  as.list()

model_summaries$s_centers %>%
  leaflet(width = "100%") %>%
  addProviderTiles(providers$CartoDB.DarkMatterNoLabels, group = "New York City") %>%
  addCircles(lng = ~ center_lon,
             lat = ~ center_lat,
             label = ~str_c("Hub - ", taxi_hub),
             color = ~hub_color,
             stroke = TRUE,
             weight = 2,
             opacity = .60,
             fillColor = "transparent",
             radius = ~if_else(hub_pct > .20, 2500, 5000),
             group = "Hub Clusters") %>%
  addCircleMarkers(data = model_summaries$s_blackmap,
                   lng = ~start_lon,
                   lat = ~start_lat,
                   opacity = ~n,
                   radius = ~sqrt(n),
                   stroke = FALSE,
                   color = "yellow",
                   popup = NULL,
                   group = "Taxi Requests") %>%
  addLayersControl(overlayGroups = c("Taxi Requests", "Hub Clusters"),
                   options = layersControlOptions(collapsed = FALSE)) %>%
  hideGroup("Hub Clusters") %>%
  setView(lng = map_center$center_lon, lat = map_center$center_lat, zoom = 11)
```

